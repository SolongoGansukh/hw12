---
title: "HW12"
author: "SolongoGansukh"
date: "2025-12-19"
output:
  html_document:
    toc: true
    number_sections: true
params: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# 1. Packages

Install packages once (uncomment to run). It's recommended to install packages interactively rather than inside the knitted document.

```{r install-packages, eval=FALSE}
install.packages("readxl")
install.packages("tidyverse")
install.packages("writexl")
install.packages("shiny")
install.packages("lubridate")
install.packages("tidyquant")
install.packages("packrat")
install.packages("rsconnect")
install.packages("knitr")
```

Load libraries:

```{r libraries}
library(tidyverse)
library(readxl)
library(writexl)
library(shiny)
library(lubridate)
library(tidyquant)
library(knitr)
```

# 2. Data import

Read the Excel / CSV files (ensure the files are in the working directory or provide full paths).

```{r data-import}
bikes_tbl <- read_excel("./bikes.xlsx")
bikeshops_tbl <- read_excel("./bikeshops.xlsx")
orderlines_tbl <- read_excel("./orderlines.xlsx")

# alternative CSV import used in some code
bike_orderlines_tbl <- read_csv("./bike_orderlines.csv")
```

Examine data:

```{r examine}
bikes_tbl
head(bikes_tbl)
```

# 3. Joining data

Left-join orderlines with bikes and bikeshops:

```{r joining}
orderlines_bikes_tbl <- left_join(orderlines_tbl, bikes_tbl, by = c("product.id" = "bike.id"))

bike_orderlines_bikeshops_joined <- left_join(orderlines_bikes_tbl, bikeshops_tbl, 
                                              by = c('customer.id' = 'bikeshop.id'))

# an alternative piped version (equivalent)
bike_orderlines_bikeshops_joined <- orderlines_tbl %>% 
  left_join(bikes_tbl, by = c("product.id" = "bike.id")) %>% 
  left_join(bikeshops_tbl, by = c("customer.id" = "bikeshop.id"))
```

# 4. Wrangling

Separate description into categories, split location, compute total price, clean names, and save RDS.

```{r wrangling}
bike_orderlines_wrangled_tbl <- bike_orderlines_bikeshops_joined %>% 
  separate(description, 
           into = c('category.1', 'category.2', 'frame.material'), 
           sep  = ' - ') %>% 
  separate(location, 
           into = c('city', 'state'), 
           sep  = ', ',
           remove = FALSE) %>%
  mutate(total.price = price * quantity) %>% 
  # Reorganize columns                                  
  select(-...1, -location) %>% 
  # Reorder columns                                  
  select(contains('date'), contains('id'), 
         contains('order'), 
         quantity, price, total.price, 
         everything()) %>% 
  # Rename columns
  rename(order_date = order.date) %>%
  set_names(names(.) %>% str_replace_all("\\.", "_"))

# save as RDS (optional)
saveRDS(bike_orderlines_wrangled_tbl, './bike_orderlines.rds')
```

# 5. Quick dplyr examples

Pull column and compute mean:

```{r pull-examples}
bike_orderlines_wrangled_tbl %>% 
  pull(total_price) %>% 
  mean()
```

Select numeric columns:

```{r select-numeric}
bike_orderlines_wrangled_tbl %>% select_if(is.numeric)
```

Arrange and filter examples:

```{r arrange-filter}
bikes_tbl %>% select(model, price) %>% arrange(desc(price))

bikes_tbl %>% 
  select(model, price) %>% 
  filter(price > mean(price))

bikes_tbl %>% 
  select(model, price) %>% 
  filter((price > 5000) & (price < 10000)) %>%    
  arrange(desc(price))

bikes_tbl %>% 
  select(model, price) %>% 
  filter(price > 6000, model %>% str_detect("Supersix"))
```

Filtering with %in%:

```{r filter-in}
bike_orderlines_wrangled_tbl %>% 
  filter(category_2 %in% c("Over Mountain", "Trail", "Endurance Road")) %>% 
  head()
```

slice, distinct, mutate examples:

```{r other-dplyr}
bikes_tbl %>% arrange(desc(price)) %>% slice((nrow(.)-4):nrow(.))

bike_orderlines_wrangled_tbl %>% distinct(category_1, category_2) %>% head()

bike_orderlines_wrangled_tbl %>% 
  mutate(total_price_log = log(total_price),
         total_price_sqrt = total_price^0.5) %>% 
  head()
```

Binning and case_when:

```{r binning}
bike_orderlines_wrangled_tbl %>% mutate(total_price_binned = ntile(total_price, 3)) %>% head()

bike_orderlines_wrangled_tbl %>% 
  mutate(total_price_binned = ntile(total_price, 3)) %>% 
  mutate(total_price_binned2 = case_when(
    total_price > quantile(total_price, 0.75) ~ "High",
    total_price > quantile(total_price, 0.25) ~ "Medium", 
    TRUE ~ "Low"
  )) %>% head()
```

Summarize and group_by:

```{r summarize}
bike_orderlines_wrangled_tbl %>% summarise(revenue = sum(total_price))

bike_orderlines_wrangled_tbl %>% 
  group_by(category_1) %>% 
  summarise(revenue = sum(total_price)) %>% 
  ungroup() %>% arrange(desc(revenue))

bike_orderlines_wrangled_tbl %>%  
  group_by(category_1, category_2, frame_material) %>% 
  summarise(revenue = sum(total_price)) %>% 
  ungroup() %>% arrange(desc(revenue))
```

# 6. Questions & quick answers

Unique categories:

```{r unique-cats}
bike_orderlines_wrangled_tbl %>% distinct(category_1)
bike_orderlines_wrangled_tbl %>% distinct(category_2)
bike_orderlines_wrangled_tbl %>% distinct(frame_material)
```

Which primary categories have largest sales:

```{r sales-by-cat1}
bike_orderlines_wrangled_tbl %>% 
  select(category_1, total_price) %>% 
  group_by(category_1) %>% 
  summarise(sales = sum(total_price)) %>%
  ungroup() %>% 
  rename(`Primary Category` = category_1, Sales = sales) %>% 
  mutate(Sales1 = Sales %>% scales::dollar()) %>% 
  head()
```

# 7. Time series: sales by year / month

```{r time-series}
str(bike_orderlines_wrangled_tbl)

bike_sales_y <- bike_orderlines_wrangled_tbl %>%
  select(order_date, total_price) %>% 
  mutate(order_date = ymd(order_date)) %>% 
  mutate(year = year(order_date)) %>% 
  group_by(year) %>% 
  summarise(sales = sum(total_price)) %>% 
  ungroup()

bike_sales_m <- bike_orderlines_wrangled_tbl %>% 
  select(order_date, total_price) %>% 
  mutate(order_date = ymd(order_date)) %>% 
  mutate(year_month = floor_date(order_date, unit = "month")) %>%
  group_by(year_month) %>% 
  summarise(sales = sum(total_price))
```

Compute percentage differences (example function provided in script):

```{r pct-diff-fn}
calculate_pct_diff <- function(data){
  data %>%
    mutate(sales_lag_1 = lag(sales, n = 1)) %>% 
    mutate(sales_lag_1 = case_when(is.na(sales_lag_1) ~ sales,
                                   TRUE ~ sales_lag_1)) %>% 
    mutate(diff_1 = sales - sales_lag_1) %>% 
    mutate(pct_diff_1 = diff_1 / sales_lag_1) %>% 
    mutate(pct_diff_1_chr = scales::percent(pct_diff_1))
}

calculate_pct_diff(bike_sales_m)
```

# 8. Plots

Total sales by year:

```{r plot-sales-year, fig.height=4, fig.width=7}
bike_sales_y %>% 
  ggplot(aes(x = year, y = sales, color = sales)) +
  geom_point(size = 5) + 
  geom_line(linewidth = 2) + 
  geom_smooth(method =  "lm", formula = 'y ~ x', se = FALSE) +
  expand_limits(y = c(0, 20e6)) + 
  scale_colour_continuous(low = "red", high = "black", 
                          labels = scales::dollar_format(scale = 1/1e6, suffix = "M")) +
  scale_y_continuous(labels = scales::dollar_format(scale = 1/1e6, suffix = "M")) + 
  labs(
    title    = "Revenue",
    subtitle = "Sales are trending up and to the right!",
    x        = "year", 
    y        = "Sales (Millions)",
    color    = "Rev ($M)",
    caption  = "Total sales from 2011 to 2015"
  )
```

Bar plot by category 2:

```{r bar-cat2, fig.height=4, fig.width=7}
revenue_by_category2_tbl <- bike_orderlines_wrangled_tbl %>% 
  select(category_2, total_price) %>% 
  group_by(category_2) %>% 
  summarise(revenue = sum(total_price)) %>% 
  ungroup()

revenue_by_category2_tbl %>% 
  mutate(category_2 = category_2 %>% as_factor() %>% fct_reorder(desc(revenue))) %>% 
  ggplot(aes(category_2, revenue)) +
  geom_col(fill = "blue")+
  coord_flip()
```

Scatter plot of order value:

```{r scatter-order-value, fig.height=4, fig.width=6}
order_value_tbl <- bike_orderlines_wrangled_tbl %>% 
  select(order_id, order_line, total_price, quantity) %>% 
  group_by(order_id) %>% 
  summarize(total_quantity = sum(quantity),
            total_price    = sum(total_price)) %>% 
  ungroup()

order_value_tbl %>% 
  ggplot(aes(x = total_quantity, y = total_price)) +
  geom_point(alpha = 0.5, size = 2)
```

Histogram / density by price and frame material:

```{r hist-density, fig.height=6, fig.width=8}
bike_orderlines_wrangled_tbl %>% 
  distinct(price, model, frame_material) %>% 
  ggplot(aes(price, fill = frame_material)) +
  geom_density(alpha = 0.5)+
  scale_fill_tq() + 
  theme_tq()
```

Box plot of unit price by category_2:

```{r boxplot-cat2, fig.height=6, fig.width=8}
unit_price_by_cat2_tbl <- bike_orderlines_wrangled_tbl %>% 
  select(category_2, model, price) %>% 
  distinct() %>% 
  mutate(category_2 = as_factor(category_2) %>% fct_reorder(price))

unit_price_by_cat2_tbl %>% 
  ggplot(aes(category_2, price)) + 
  geom_boxplot() + 
  coord_flip()+
  theme_tq()
```

Lollipop / top customers example and heatmap:

```{r top-customers-heatmap, fig.height=6, fig.width=9}
n <- 10
topN_customers <- bike_orderlines_wrangled_tbl %>% 
  select(bikeshop_name, total_price) %>% 
  mutate(bikeshop_name = as_factor(bikeshop_name) %>% fct_lump(n = n, w = total_price)) %>% 
  group_by(bikeshop_name) %>% 
  summarize(revenue = sum(total_price)) %>% 
  ungroup() %>% 
  mutate(bikeshop_name = bikeshop_name %>% fct_reorder(revenue)) %>% 
  mutate(bikeshop_name = bikeshop_name %>% fct_relevel("Other", after =0)) %>% 
  arrange(desc(bikeshop_name)) %>% 
  mutate(revenue_text = scales::dollar(revenue)) %>% 
  mutate(cum_pct = cumsum(revenue) / sum(revenue)) %>% 
  mutate(cum_pct_txt = scales::percent(cum_pct)) %>% 
  mutate(rank = row_number()) %>% 
  mutate(rank = case_when(rank == max(rank) ~NA_integer_, TRUE ~ rank)) %>% 
  mutate(label_text = str_glue("Rank: {rank}\nRev {revenue_text} \ncum {cum_pct_txt}"))

topN_customers %>% 
  ggplot(aes(revenue, bikeshop_name)) +
  geom_segment(aes(xend = 0, yend = bikeshop_name))+
  geom_point(aes(size = revenue)) + 
  geom_label(aes(label = label_text), hjust = "inward")

pct_sales_by_customer_tbl <- bike_orderlines_wrangled_tbl %>% 
  select(bikeshop_name, category_1, category_2, quantity) %>% 
  group_by(bikeshop_name, category_1, category_2) %>% 
  summarise(total_qty = sum(quantity)) %>% 
  ungroup() %>% 
  group_by(bikeshop_name) %>% 
  mutate(pct = total_qty / sum(total_qty)) %>% 
  ungroup() %>% 
  mutate(bikeshop_name  = as.factor(bikeshop_name) %>% fct_rev())

pct_sales_by_customer_tbl %>% 
  ggplot(aes(category_2, bikeshop_name)) +
  geom_tile(aes(fill = pct)) + 
  geom_text(aes(label = scales::percent(pct)), size = 3)+
  scale_fill_gradient(low = "white", high = "black") + 
  facet_wrap(~ category_1) + 
  labs(title = "Heatmap of purchasing habits", x = "Bike type (category 2)", y = "Customer")
```

# 9. String manipulation & feature engineering

Examples of str_detect, str_c, str_glue, and a function to separate and engineer model features:

```{r string-fe}
bikes_tbl %>% 
  select(model) %>% 
  mutate(supersix = model %>% str_detect("Supersix") %>% as.numeric()) %>% 
  mutate(black    = model %>% str_detect("Black") %>% as.numeric())

str_c("Order Line: ", 1, ".", 1)
str_glue("Order Line: {1}.{1}")

bike_orderlines_tbl %>% 
  select(bikeshop_name, order_id, order_line) %>% 
  mutate(purchase_statement = str_glue(
    "Order Line: {order_id}.{order_line} sent to Customer: {str_to_upper(bikeshop_name)}"
  ) %>% as.character())
```

Separation and cleaning of bike model examples and helper function:

```{r model-sep}
separate_bike_model <- function(data, append = TRUE) {
  if (!append){
    data <- data %>% select(model)
  }
  
  output_tbl <- data %>% select(model) %>% 
    mutate(model = case_when(
      model == "CAAD Disc Ultegra" ~ "CAAD12 Disc Ultegra", 
      model == "Supersix Evo Hi-Mod Utegra" ~ "Supersix Evo Hi-Mod Ultegra",
      model == "Syapse Carbon Tiagra" ~ "Synapse Carbon Tiagra", 
      TRUE ~ model)
    ) %>% 
    separate(col = model, into = str_c("model_", 1:7), sep = " ", remove = FALSE, fill = "right") %>% 
    mutate(model_base = case_when(
      str_detect(str_to_lower(model_1), "supersix") ~ str_c(model_1, model_2, sep = " "),
      str_detect(str_to_lower(model_1), "beast") ~ str_c(model_1, model_2, model_3, model_4, sep = " "),
      str_detect(str_to_lower(model_1), "bad") ~ str_c(model_1, model_2, sep = " "), 
      str_detect(str_to_lower(model_1), "fat") ~ str_c(model_1, model_2, sep = " "), 
      str_detect(str_to_lower(model_1), "29") ~ str_c(model_1, model_2, sep = " "),
      TRUE ~ model_1
    )) %>% 
    mutate(model_tier = model %>% str_replace(model_base, replacement = "") %>% str_trim()) %>% 
    select(-matches("model_[0-9]")) %>% 
    mutate(black  = model_tier %>% str_to_lower() %>% str_detect("black") %>% as.numeric(),
           red    = model_tier %>% str_to_lower() %>% str_detect("red") %>% as.numeric(),
           hi_mod = model_tier %>% str_to_lower() %>% str_detect("hi_mod") %>% as.numeric(),
           team   = model_tier %>% str_to_lower() %>% str_detect("team") %>% as.numeric(),
           ultegra = model_tier %>% str_to_lower() %>% str_detect("ultegra") %>% as.numeric(),
           dura_ace = model_tier %>% str_to_lower() %>% str_detect("dura_ace") %>% as.numeric(),
           disc    = model_tier %>% str_to_lower() %>% str_detect("disc") %>% as.numeric())
  
  return(output_tbl)
}

# Example usage
separate_bike_model(bikes_tbl)
```

# 10. Shiny (from original script)

The original script loaded packrat, rsconnect, and created a minimal server. Typically Shiny app code should be in a separate app.R or run interactively. The following is the server placeholder and original call left commented (do not call shinyApp when knitting the Rmd).

```{r shiny-code, eval=FALSE}
library(packrat)
library(rsconnect)
library(knitr)

server <- function(input, output, session) {
  # server logic here
}

# The following would launch the app interactively; keep commented in Rmd
# shinyApp(ui = ui, server = server)
```

# Session info

```{r session-info}
sessionInfo()
```